% Package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mossentials}[2018/09/10 Moritz's essentials package]


%=========%
% Options %
%=========%
% The available options for now are:
% Fonts: lmodern, gfsdidot, fourier, libertine, garamond
% colorlinks
% onehalfspacing, doublespacing
% german
\newcommand{\lang}{english}
\newcommand{\langcode}{UK}
\DeclareOption{german}{
    \renewcommand{\lang}{ngerman}
    \renewcommand{\langcode}{DE}
}

% Set spacing
%\DeclareOption{onehalfspacing}{\RequirePackage[onehalfspacing]{setspace}}
%\DeclareOption{doublespacing}{\RequirePackage[doublespacing]{setspace}}

% Colorlinks
\newcommand{\colorlinks}{false}
\DeclareOption{colorlinks}{\renewcommand{\colorlinks}{true}}

% Font
\newcommand{\customfont}{kpfonts}
\DeclareOption{lmodern}{\renewcommand{\customfont}{lmodern}} % Latex default font, but improved
\DeclareOption{fourier}{\renewcommand{\customfont}{fourier}} % Adobe Utopia font
\DeclareOption{garamond}{\renewcommand{\customfont}{ebgaramond-maths}} % Garamond
\DeclareOption{gyre}{\renewcommand{\customfont}{tgpagella}} % Tex Gyre Pagella
\DeclareOption{libertine}{\renewcommand{\customfont}{libertinus}} % Nice sans serif font

% End of options
\DeclareOption*{\PackageWarning{mossentials}{Unknown ‘\CurrentOption’}}
\ProcessOptions\relax


%====================%
% Important packages %
%====================%
\RequirePackage[l2tabu, orthodox]{nag} % Warns of deprecated LaTeX constructs
\RequirePackage[T1] {fontenc} 
\RequirePackage[utf8]{inputenc}
\RequirePackage[\lang]{babel} % Language specific small stuff (formatting and so on)
\RequirePackage{\customfont} % Set the font
\RequirePackage{csquotes} % Better quoting, but mainly here because it is recommended for babel and biblatex
\RequirePackage[
backend=biber,
hyperref=true,
doi=true,
url=false,
eprint=false,
style=numeric-comp, % Haven't decided on a style yet
sorting=none, % Sorts in citation order, which is the only sorting method that makes sense if using numeric style
autocite=superscript,
]{biblatex} % Biblatex


%========================%
% Miscellaneous packages %
%========================%
\RequirePackage{color} % Colors
\RequirePackage{colortbl} % Colors in table
\RequirePackage[table]{xcolor} % Allow colored text
\RequirePackage{pdflscape} % Landscape pdf pages with \begin{landscape} ... \end{landscape}
%\RequirePackage{emptypage} % Ensures removed headers and footers on empty pages (like the one after the title)
\RequirePackage[final]{microtype} % Better font spacing and stuff. Final option provides that it is not disabled in draft mode
\RequirePackage[left=1.50cm, right=1.50cm, top=3.00cm, bottom=3.00cm]{geometry} % StyleGuide standards
\RequirePackage{xspace} % In commands, \xspace makes a space after the command only if there is a word. In case of punctuation, it is omitted.
\RequirePackage[obeyDraft]{todonotes} % Allows TODO notes in the text with \todo{note}, then can make a \listoftodos
\RequirePackage{anyfontsize} % More flexibility in font sizes
\RequirePackage{xparse} % Better macro and environment declaration


%=====================%
% Chemistry and maths %
%=====================%
\RequirePackage{chemformula} % Stuff like \ch{MgCl2}
\RequirePackage{chemmacros} % Extension of chemformula, most notably contains \iupac{}, very useful for long IUPAC names containing heteroatoms, stereochemistry, greek letters and stuff. Also allows line breaking
\RequirePackage{chemfig} % Structural formulas drawn with tikz. Not so easy to use, but looks very nice. Still looking for an easier alternative
\RequirePackage{mathtools} % Math stuff
\RequirePackage{amsfonts} % Math stuff (continued)
\RequirePackage{amssymb} % Math stuff (continued)
\RequirePackage[
per-mode=reciprocal-positive-first, % Format of units (fraction or reciprocal)
locale=\langcode, % Set locale
range-units=single, % Don't repeat units in number ranges
list-units=single, % Don't repeat units in number lists
detect-all, % Apply same font settings to the number/unit as the surrounding text
forbid-literal-units=true, % Only allow predefined units to enforce consistency
]{siunitx} % Nice SI units, but also for number formatting/alignment in tables (with s and S column specifier)
\DeclareSIUnit{\basepair}{bp} % Declare basepairs as a unit (important for DNA double strands)
\DeclareSIUnit{\base}{b} % Declare bases as a unit (important for DNA single strands)
\DeclareSIUnit{\molar}{\textsc{m}} % Declare molarity as unit (equals mol/l)
\DeclareSIUnit{\mmolar}{\milli\molar} % Declare molarity as unit (equals mmol/l)
\DeclareSIUnit{\enzymeunit}{U} % Declare units as unit (enzyme activity)
\DeclareSIUnit{\xg}{g} % Declare centrifugal force (g) as unit
\DeclareSIUnit{\rpm}{rpm} % Declare rounds per minute as unit
\DeclareSIUnit[number-unit-product = {}]{\percent}{\%} % Remove space before
                                % percent sign


%=========================%
% Floats, figures, images %
%=========================%
\RequirePackage[section]{placeins} % Floats can not be printed behind the next section.
\RequirePackage{subfig} % Subfigures, subcaptions
\RequirePackage{caption} % Better captions, more customisable
\RequirePackage{tikz} % Figures you can draw on (text, lines, braces, stuff)
\RequirePackage[
    pdfpagelabels=true, % Sets PDF page labels, so that PDF readers can detect different numbering styles (e.g. roman in \frontmatter)
    plainpages=false, % Fixes errors caused by page numbering resets (as by \frontmatter, \mainmatter and \backmatter)
    colorlinks=\colorlinks, % Make links (as in TOC or references to figures) font red instead of drawing a red box around them. Colorlinks are also visible in print, boxes are not
    bookmarks=true,% Make booksmarks
    pdfview=FitB, % When clicking a link, determines the view that will be shown. FitB fits the page bounding box to the window
    final % Make links, no matter if draft mode or not
]{hyperref} % Required for the hyperlinks within the PDF
\RequirePackage{cleveref} % Nice referencing with \cref{}


%==============%
% Biochemistry %
%==============%
\RequirePackage{seqsplit} % Split long single words in tables (such as DNA sequences) using \seqsplit{text}
\RequirePackage{dnaseq} % Format DNA sequences nicely using \DNA! ATG!
%\RequirePackage{pgfmolbio} % Super nice display of sequencing data, protein secondary structure etc.
\RequirePackage{texshade} % Typeset nucleotide and amino acid alignments
\RequirePackage{textopo} % Annotated membrane protein topology plots


%============%
%Table stuff %
%============%
\RequirePackage{booktabs} % \toprule, \midrule, \bottomrule, nicer tables (must have!)
\RequirePackage{multirow} % \multicolumn{num_of_columns}{X}{Content} and \multirow{num_of_rows}{X}{Content}
\RequirePackage{multirow,bigdelim} % Braces spanning multiple rows
\RequirePackage{xltabular} % A combination of longtable and tabularx. Useful for multi=page tables
\RequirePackage{csvsimple} % Read csv files as tables


%======%
% URLs %
%======%
\RequirePackage{url}
\urlstyle{same}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Setup command for gel and future environments %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand{\biochemsetup}{>{\TrimSpaces}m}{
  \pgfkeys{
    /biochem/config/.cd,
    gel-base-path/.initial=./,
    gel-config-base-path/.initial=./,
    gel-textsize/.initial=\scriptsize,
    #1,
  }
}
\biochemsetup{} % Call it once, so the key/value pairs are initialised

%%%%%%%%%%%%%%%%%%%
% Gel environment %
%%%%%%%%%%%%%%%%%%%
% Arguments are:
% #1: Width (optional, default .5\textwidth)
% #2: Image file (preferably omit file ending)
\NewDocumentEnvironment{gel}{O{.5\textwidth} m}{\noindent\ignorespaces
    % START OF BEFORE BLOCK
  \pgfkeys{/biochem/config/gel-textsize/.get=\@textsize,
  }

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % ========== MARKER ========== %
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw marker on left side
    % #1: Unit
    % #2: Marker list
    \pgfkeysdefnargs{/gel/marker/drawleft}{2}{
        \node[anchor=south east, inner sep=0] at (0, 1) {\@textsize\si{##1}};
        \foreach \y/\t in ##2 {
            \draw (0, \y) -- +(-1mm, 0) node[anchor=east, inner sep=0] {\@textsize\t};
        }
    }
    % Draw marker on right side
    % #1: Unit
    % #2: Marker list
    \pgfkeysdefnargs{/gel/marker/drawright}{2}{
        \node[anchor=south west, inner sep=0] at (1, 1) {\@textsize\si{##1}};
        \foreach \y/\t in ##2 {
            \draw (1, \y) -- +(1mm, 0) node[anchor=west, inner sep=0] {\@textsize\t};
        }
    }
    % Draw hlines
    % #1: List
    % #2: Unused
    \pgfkeysdefnargs{/gel/marker/hlines}{2}{
        \foreach \y/\t in ##1 {
            \draw[dotted] (0, \y) -- (1, \y);
        }
    }
    % Main marker command:
    % #1: Key/value parameters
    % #2: Unit
    % #3: List
    \newcommand{\marker}[3][]{
        \pgfkeys{/gel/marker/.cd,
            side/.initial=left,
            hlines/.default={{##3}}{},
            ##1,
            draw\pgfkeysvalueof{/gel/marker/side}={##2}{{##3}},
        }
    }

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % ========== LANES ========== %
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw lane texts. Needs two arguments for some reason, otherwise it will only print a 0 at (0,1). Second argument is empty
    % #1: List
    % #2: Unused, but for some reason needs to exist...
    \pgfkeysdefnargs{/gel/lanes/draw}{2}{
        \foreach[count = \laneindex] \x/\t in ##1 {
            \node[rotate=\pgfkeysvalueof{/gel/lanes/rotation},
            anchor=\pgfkeysvalueof{/gel/lanes/anchor},
            text height=1.5ex,
            text depth=0.1ex] (\laneindex) at (\x,1) {\@textsize\t};
        }
    }
    % main lanes command
    % #1: Key/value parameters
    % #2: List
    \newcommand{\lanes}[2][]{
        \pgfkeys{
            /gel/lanes/.cd,
            rotation/.initial=0,
            anchor/.initial=south,
            ##1,
            draw={{##2}}{},
        }
    }

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % ========== MULTILANES ========== %
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Draw multilanes
    % #1: List, format: laneindex1/laneindex2/text
    % #2: Unused, same problem as in lanes code...
    \pgfkeysdefnargs{/gel/multilanes/draw}{2}{
        \foreach \start/\end/\text in ##1 {
            \draw (\start.\pgfkeysvalueof{/gel/multilanes/anchor} west) -- node[above,
            text height=1.5ex,
            text depth=0.1ex]{\@textsize\text} (\end.\pgfkeysvalueof{/gel/multilanes/anchor} east);
        }
    }
    % Main multilanes command
    \newcommand{\multilanes}[2][]{
        \pgfkeys{
            /gel/multilanes/.cd,
            anchor/.initial=north,
            ##1,
            draw={{##2}}{},
        }
    }

    % Start the tikzpicture environment
    \begin{tikzpicture}
        \node[align=center, anchor=south west,inner sep=0] (image) at (0,0) {\includegraphics[width=#1]{#2}};
        \begin{scope}[x={(image.south east)},y={(image.north west)}]
          % Input config file if it exists
          \IfFileExists{\pgfkeysvalueof{/biochem/config/gel-config-base-path}#2.tex}{
            \input{\pgfkeysvalueof{/biochem/config/gel-config-base-path}#2.tex}}{}
    }% SWITCH FROM BEGIN TO END BLOCK
    {\ignorespacesafterend
        \end{scope}
    \end{tikzpicture}
    % END OF AFTER BLOCK
}
\endinput
